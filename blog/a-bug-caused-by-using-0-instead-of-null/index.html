<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>A Bug Caused by Using 0 Instead of Null :: Ismail Badawi</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This is a quick post about a bug I ran into at work which turned out to be caused by passing a literal 0 instead of NULL to a function. Here&amp;rsquo;s a small program reproducing it:
" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://ismail.badawi.io/blog/a-bug-caused-by-using-0-instead-of-null/" />




<link rel="stylesheet" href="https://ismail.badawi.io/assets/style.css">

  <link rel="stylesheet" href="https://ismail.badawi.io/assets/blue.css">






<link rel="apple-touch-icon" href="https://ismail.badawi.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://ismail.badawi.io/img/favicon/blue.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="A Bug Caused by Using 0 Instead of Null">
<meta property="og:description" content="This is a quick post about a bug I ran into at work which turned out to be caused by passing a literal 0 instead of NULL to a function. Here&amp;rsquo;s a small program reproducing it:
" />
<meta property="og:url" content="https://ismail.badawi.io/blog/a-bug-caused-by-using-0-instead-of-null/" />
<meta property="og:site_name" content="Ismail Badawi" />

  
    <meta property="og:image" content="https://ismail.badawi.io/img/favicon/blue.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2015-09-08 00:00:00 &#43;0000 UTC" />












</head>
<body class="blue">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Ismail Badawi
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://ismail.badawi.io/blog/a-bug-caused-by-using-0-instead-of-null/">A Bug Caused by Using 0 Instead of Null</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2015-09-08 
      </span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://ismail.badawi.io/tags/c/">c</a>&nbsp;
    
    #<a href="https://ismail.badawi.io/tags/code/">code</a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <p>This is a quick post about a bug I ran into at work which turned out to be
caused by passing a literal <code>0</code> instead of <code>NULL</code> to a function. Here&rsquo;s a
small program reproducing it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdarg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f</span>(<span style="color:#66d9ef">int</span> arg, ...) {
  va_list args;
  va_start(args, arg);
  <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>p;
  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> arg; <span style="color:#f92672">++</span>i) {
    p <span style="color:#f92672">=</span> va_arg(args, <span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>);
  }
  <span style="color:#66d9ef">if</span> (p) {
    printf(<span style="color:#e6db74">&#34;p was non-null: %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, p);
  } <span style="color:#66d9ef">else</span> {
    printf(<span style="color:#e6db74">&#34;p was null</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
  }
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
  f(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
  f(<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Compiling this as a 64-bit program on an x86-64 processor with clang
and running it gives this output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ clang test.c
$ ./a.out
p was null
p was non-null: 0x7fff00000000
</code></pre></div><p>What is going on here?</p>
<p>First, what is this <code>f</code> function doing? It takes an integer argument,
followed by a variable number of arguments. It uses the first argument
to decide which of the variable arguments to look at (starting at 1),
and interprets it as a pointer value. Thus, if the call looked like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">f(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>);
</code></pre></div><p>Then <code>p</code> would take on the value <code>(int*)3</code>.</p>
<p>For the two calls in the program, I&rsquo;m passing in 6 literal <code>0</code>s as the variable
arguments. The first call examines the 5th one, and the second the 6th one. In
the first case, <code>p</code> turns out be 0, as expected. But in the second case, it is
nonzero. How come?</p>
<p>There are two things going on.</p>
<ol>
<li>
<p>In the <a href="http://www.x86-64.org/documentation/abi.pdf">x86-64 calling convention</a> (refer to section 3.2.3), up to six
integer arguments can be passed in registers. In the case of <code>f</code>, this
includes the fixed positional argument <code>arg</code>, and then up to 5 arguments. In
both calls I am passing six extra arguments, so the last one is passed on
the stack, instead of in a register.</p>
</li>
<li>
<p>In C, the literal <code>0</code> has type <code>int</code>, which is a 32-bit value. Thus, 32 bits
worth of zeros are placed on the stack at the call site. But when <code>f</code>
interprets the argument as a pointer, it reads 64 bits from the stack. The
first 32 bits are zeros, but the next 32 are garbage &ndash; whatever happens to
be on the stack (which could happen to be all zeros, or it might not, as in
this case).</p>
</li>
</ol>
<p>If the last argument was <code>NULL</code> instead of <code>0</code>, then 64 bits worth of zeros
would have been placed on the stack at the call site, since <code>NULL</code> is typically
defined as something like <code>((void*)0)</code>, which is an expression of pointer type.</p>
<p>I&rsquo;m not sure how consistent this behavior is across platforms or compilers. In
particular, it seems that there exist ABIs where values passed as varargs are
automatically sign-extended to 64 bits &ndash; so the program here would be fine.</p>
<p>I tend to avoid using varargs in C, unless I&rsquo;m just wrapping <code>printf</code> or
something. They&rsquo;re not type-checked, which is already giving up a lot, and then
on 64-bit systems they can be pretty complicated to reason about. Here is an
<a href="https://blog.nelhage.com/2010/10/amd64-and-va_arg/">interesting article</a> about the implementation of varargs in the amd64
ABI.</p>
      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://ismail.badawi.io/blog/read-only-file-in-writable-directory/">
                <span class="button__icon">←</span>
                <span class="button__text">Read Only File in Writable Directory</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://ismail.badawi.io/blog/when-optimizations-hide-bugs/">
                <span class="button__text">When Optimizations Hide Bugs</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
<center>Have a comment on this article? <a href="https://github.com/isbadawi/isbadawi.github.io/discussions">Start a discussion</a> on this blog's GitHub repo.</center>


</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2021 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://ismail.badawi.io/assets/main.js"></script>
<script src="https://ismail.badawi.io/assets/prism.js"></script>







  
</div>

</body>
</html>
